<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CESIUM | BIM Viewer - Lighting v4.0 (WITH LOGIN)</title>
  
  <!-- Favicon Fix -->
  <link rel="icon" href="data:,">
  
  <!-- Cesium Library -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.134/Build/Cesium/Cesium.js"></script>
  <link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.134/Build/Cesium/Widgets/widgets.css">
  
  <!-- Firebase SDK (with Auth!) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <!-- Modern Styles -->
  <link rel="stylesheet" href="style.css">
  
  <!-- üîê Auth Styles (NEW!) -->
  <link rel="stylesheet" href="auth-styles.css">
  
  <!-- Z-Offset Styles -->
  <link rel="stylesheet" href="integrated-zoffset-styles.css">
  
  <!-- üî• Lighting v4.0 Styles -->
  <link rel="stylesheet" href="lighting-styles.css">
  
  <!-- Comments Styles -->
  <link rel="stylesheet" href="comments-styles.css">
</head>
<body>

  <!-- ============================================
       üîê LOGIN SCREEN (Shows first!)
       ============================================ -->
  <div id="loginScreen">
    <div class="login-container">
      <div class="login-header">
        <span class="login-icon">üèóÔ∏è</span>
        <h1>CESIUM BIM Viewer</h1>
        <p>Bitte melden Sie sich an</p>
      </div>
      
      <form id="loginForm" class="login-form">
        <div class="login-field">
          <label for="loginEmail">E-Mail</label>
          <input type="email" id="loginEmail" placeholder="ihre@email.de" required autocomplete="email">
        </div>
        
        <div class="login-field">
          <label for="loginPassword">Passwort</label>
          <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
        </div>
        
        <div id="loginError"></div>
        
        <button type="submit" id="loginBtn" class="login-btn">
          <span id="loginSpinner"></span>
          <span id="loginBtnText">Anmelden</span>
        </button>
      </form>
      
      <div class="login-footer">
        <small>Zugang nur f√ºr autorisierte Benutzer</small>
      </div>
    </div>
  </div>

  <!-- ============================================
       MAIN APP (Hidden until logged in)
       ============================================ -->
  
  <!-- Main Cesium Container -->
  <div id="cesiumContainer" style="display: none;"></div>
  
  <!-- Modern Toolbar -->
  <div id="toolbar" style="display: none;"></div>
  
  <!-- Custom Info Box -->
  <div id="infoBoxCustom"></div>
  
  <!-- Drawing Mode Indicator -->
  <div id="modeIndicator" class="mode-indicator">
    ‚úèÔ∏è DRAWING MODE ACTIVE - Click map to add polygon points
  </div>

  <!-- Hide Mode Indicator -->
  <div id="hideModeIndicator" class="mode-indicator">
    üôà HIDE MODE - Click on elements to hide (ESC or H to exit)
  </div>

  <!-- Comment Mode Indicator -->
  <div id="commentModeIndicator" class="mode-indicator">
    üí¨ COMMENT MODE - RIGHT-CLICK on 3D model to place comment (ESC or C to exit)
  </div>

  <!-- Status Indicator -->
  <div id="statusIndicator" class="status-indicator">
    Status updates will appear here
  </div>

  <!-- Comment Dialog -->
  <div id="commentDialog" style="position: absolute; display: none; background: rgba(26, 32, 44, 0.98); backdrop-filter: blur(10px); border-radius: 16px; padding: 24px; color: white; z-index: 200; box-shadow: 0 16px 48px rgba(0,0,0,0.6); min-width: 380px; max-width: 420px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
    <h4 style="margin-top: 0; margin-bottom: 20px; color: #667eea; font-size: 18px; font-weight: 700;" id="commentDialogTitle">New Comment</h4>
    
    <div style="margin-bottom: 16px;">
      <label style="display: block; font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Title *</label>
      <input type="text" id="commentTitleInput" placeholder="Comment title..." style="width: 100%; padding: 12px 14px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: white; box-sizing: border-box; font-size: 14px; transition: all 0.2s ease;">
    </div>
    
    <div style="margin-bottom: 16px;">
      <label style="display: block; font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Comment *</label>
      <textarea id="commentTextInput" placeholder="Your comment..." style="width: 100%; padding: 12px 14px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: white; min-height: 120px; resize: vertical; box-sizing: border-box; font-size: 14px; font-family: inherit; transition: all 0.2s ease;"></textarea>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
      <div>
        <label style="display: block; font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Category</label>
        <select id="commentCategory" style="width: 100%; padding: 10px 14px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: white; box-sizing: border-box; font-size: 14px;">
          <option value="General">üìã General</option>
          <option value="Architecture">üèõÔ∏è Architecture</option>
          <option value="Structure">üóø Structure</option>
          <option value="MEP">‚ö° MEP</option>
          <option value="Issue">‚ö†Ô∏è Issue</option>
          <option value="Question">‚ùì Question</option>
        </select>
      </div>
      
      <div>
        <label style="display: block; font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Priority</label>
        <select id="commentPriority" style="width: 100%; padding: 10px 14px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: white; box-sizing: border-box; font-size: 14px;">
          <option value="Low">‚ö™ Low</option>
          <option value="Normal" selected>üîµ Normal</option>
          <option value="High">üî¥ High</option>
        </select>
      </div>
    </div>
    
    <div style="display: flex; gap: 12px;">
      <button onclick="BimViewer.closeCommentDialog()" style="flex: 1; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 12px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease;">
        Cancel
      </button>
      <button onclick="BimViewer.saveCommentFromDialog()" style="flex: 1; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3); transition: all 0.2s ease;">
        Save Comment
      </button>
    </div>
  </div>

  <style>
    #commentDialog input:focus,
    #commentDialog textarea:focus,
    #commentDialog select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background: rgba(255,255,255,0.08);
    }
    
    #commentDialog button:hover {
      transform: translateY(-1px);
    }
    
    #commentDialog button:active {
      transform: translateY(0);
    }
    
    #commentDialog button:last-child:hover {
      box-shadow: 0 6px 16px rgba(17, 153, 142, 0.4);
    }
  </style>

  <!-- ============================================
       JAVASCRIPT MODULES - LOAD ORDER IS CRITICAL!
       ============================================ -->
  
  <!-- üîê Auth Module (FIRST!) -->
  <script src="auth.js"></script>
  
  <!-- 1. Core Modules (Foundation) -->
  <script src="core.js"></script>
  <script src="features.js"></script>
  <script src="hideFeatures.js"></script>
  <script src="comments.js"></script>
  <script src="pointcloud.js"></script>
  <script src="measurement.js"></script>
  
  <!-- 2. Enhanced Clipping Module -->
  <script src="clipping.js"></script>
  
  <!-- 3. Z-Offset Module v2.0 -->
  <script src="z-offset.js"></script>
  
  <!-- ============================================
       üî• LIGHTING v4.0 - NEW SETUP
       ============================================ -->
  
  <!-- 4. üî• Lighting Module v4.0 (MUST be loaded FIRST!) -->
  <script src="lighting.js"></script>
  
  <!-- 4.5. üî• NEW: Standalone Lighting UI (loads BEFORE ui.js) -->
  <script src="ui-lighting-standalone.js"></script>
  
  <!-- ============================================
       UI MODULES
       ============================================ -->
  
  <!-- 5. UI Module v3.3 -->
  <script src="ui.js"></script>
  
  <!-- 6. UI Extensions -->
  <script src="ui-comments-extension.js"></script>
  <script src="ui-clipping-extension.js"></script>
  <script src="ui-z-offset-extension.js"></script>
  
  <!-- 7. ‚ö†Ô∏è OLD Lighting UI Extension - NOT NEEDED ANYMORE (auskommentiert) -->
  <!-- <script src="ui-lighting-extension.js"></script> -->
  
  <!-- 8. UI Helpers (final touches) -->
  <script src="ui-helpers-modern.js"></script>
  
  <!-- ============================================
       INITIALIZATION SCRIPT
       ============================================ -->
  <script>
    window.addEventListener('load', function() {
      console.log('üöÄ Page loaded, waiting for authentication...');
      
      // Wait for auth and then initialize
      const initSystems = setInterval(function() {
        // First check if user is logged in
        if (!BimAuth || !BimAuth.isLoggedIn()) {
          console.log('‚è≥ Waiting for login...');
          return;
        }
        
        // ‚úÖ NEW: Check if Ion Token is available
        const ionToken = BimAuth.getIonToken();
        if (!ionToken) {
          console.log('‚è≥ Waiting for Cesium Ion Token...');
          return;
        }
        
        // ‚úÖ NEW: Apply Ion Token to Cesium
        if (typeof Cesium !== 'undefined' && Cesium.Ion) {
          Cesium.Ion.defaultAccessToken = ionToken;
          console.log('‚úÖ Cesium Ion Token applied');
        }
        
        console.log('‚úÖ User authenticated, initializing BIM Viewer...');
        console.log('');
        console.log('üìã MODULE LOAD ORDER:');
        console.log('   0. üîê Auth (Login protection)');
        console.log('   0.5 üõ∞Ô∏è Ion Token (User specific)');
        console.log('   1. Core, Features, Comments, etc.');
        console.log('   2. Clipping, Z-Offset');
        console.log('   3. üî• Lighting v4.0 (NEW - Fixed & Working)');
        console.log('   4. üî• Standalone Lighting UI (NEW)');
        console.log('   5. UI.js');
        console.log('   6. UI Extensions');
        console.log('   7. UI Helpers');
        console.log('');
        
        // Wait for BimViewer and an asset to be loaded
        if (typeof BimViewer !== 'undefined' && BimViewer.viewer) {
          
          // ‚≠ê EARLY INIT: Initialize lighting system IMMEDIATELY
          if (typeof BimViewer.initLighting === 'function' && !BimViewer.lighting) {
            BimViewer.initLighting();
            console.log('‚úÖ Lighting system initialized (early)');
          } else if (!BimViewer.initLighting) {
            console.warn('‚ö†Ô∏è BimViewer.initLighting not found - lighting-v4.js may not be loaded!');
          }
          
          // Check if at least one asset is loaded
          if (BimViewer.loadedAssets && BimViewer.loadedAssets.size > 0) {
            clearInterval(initSystems);
            console.log('‚úÖ Asset detected, initializing all systems...');
            
            // Initialize Firebase (comments - auth is separate)
            if (BimViewer.initFirebase && BimViewer.initFirebase()) {
              console.log('‚úÖ Firebase Firestore initialized for comments');
              const statusEl = document.getElementById('commentsListStatus');
              if (statusEl) statusEl.textContent = 'Ready';
            } else {
              console.log('‚ö†Ô∏è Firebase Firestore initialization failed - showing manual init button');
              const initBtn = document.getElementById('initFirebaseBtn');
              if (initBtn) initBtn.style.display = 'block';
              const statusEl = document.getElementById('commentsListStatus');
              if (statusEl) statusEl.textContent = 'Not initialized';
            }
            
            // Initialize comment click handler
            if (typeof BimViewer.initCommentClickHandler === 'function') {
              BimViewer.initCommentClickHandler();
              console.log('‚úÖ Comment click handler initialized');
            }
            
            // Initialize hide features
            if (typeof BimViewer.initHideFeatures === 'function') {
              BimViewer.initHideFeatures();
              console.log('‚úÖ Hide features initialized');
            }
            
            // Initialize point cloud settings
            if (typeof BimViewer.initPointCloudSettings === 'function') {
              BimViewer.initPointCloudSettings();
              console.log('‚úÖ Point cloud settings initialized');
            }
            
            console.log('üéâ All systems ready!');
            console.log('');
            console.log('üîê LOGGED IN AS:', BimAuth.getCurrentUser()?.email);
            console.log('üõ∞Ô∏è ION TOKEN:', ionToken.substring(0, 20) + '...');
            
          } else {
            // Update status to show waiting for asset
            const statusEl = document.getElementById('commentsListStatus');
            if (statusEl) {
              statusEl.textContent = 'Waiting for asset...';
            }
          }
        }
      }, 500);
    });
  </script>
</body>
</html>
